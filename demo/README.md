Тестирование оплаты, режим демо, Яндекс.Касса
========================================
**Инструкция для самописных сайтов**  
На этой странице вы найдете пример кода платежной формы, пошаговое описание тестирования, решение ошибок при тестировании, презентацию процесса оплаты методом "оплатить через яндекс", ссылки на необходимые документы и файлы дизайна, раздел FAQ и раздел Рекомендации.

---

### Тестирование

Для тестирования необходимы **shopId** и **scid**. Вы получите их в письме, после того, как менеджер Яндекс.Кассы выполнит процесс вашей регистрации:
> **shopId** (идентификатор магазина) = **100500**  
> **scid** (номер витрины) = **555777**  
> _это пример идентификторов из письма_

1. Создайте платежную форму, прописав в ней ваши **shopId** и **scid**;
2. Создайте скрипты для обработки наших запросов (скрипт checkURL и скрипт avisoURL; это может быть один скрипт, который будет обработывать оба запроса);  
**2.1** Проверьте корректность сверки MD5 суммы в скриптах checkURL и avisoURL;
3. Выполните тестирование оплаты;
4. После успешной оплаты в демо-режиме, напишите нам и мы переведем вас в боевой режим.
5. Если при тестировании возникнут ошибки и информации на данной странице будет не достаточно, напишите нам (какая информация нужна для диагностики, см. в инструкции ниже).

#### Шаг 1. Создание платежной формы
Файл "пример платежной формы.html" содержит необходимый код, чтобы выполнить тестовый платеж. Скопируйте код к себе, отредактируйте, прописав свои значения **shopId** и **scid**. В файле примера это будут следующие строки:

    <input type="hidden" name="shopId" value="впишите-сюда-значение-своего-shopId">
    <input type="hidden" name="scid" value="впишите-сюда-значение-своего-scid">

Вставьте код в html-документ или добавьте на страницу своего сайта. Минимальная платежная форма готова.

Обратите внимание:
* обязательными параметрами платежа являются **shopId**, **scid**, **customerNumber** и **sum**, без них платежи работать не будут (customerNumber - идентификатор плательщика, например, "Покупатель N1"; sum - сумма платежа в рублях);
* если выхотите передавать больше данных из формы, прочитайте как это сделать в [документации](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/);
* для демо платежей и платежей в реале, значение shopId одинаковое;
* значение scid для демо будет одно, а для реала другое; если вы пропишите боевой scid для платежей в демо, то платежи в демо работать не будут.

#### Шаг 2. Колбеки checkURL и avisoURL

При регистрации в Яндекс.Кассе вы заполняли техническую анкету, где должны были указать ссылки на ваши скрипты, которые будут обрабатывать наши запросы. У нас они называются checkURL и avisoURL. URL этих скриптов прописаны в настройках вашего shopId.

* На ваш checkURL мы отправляем запрос ([action=checkOrder](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-check-docpage/)), который проверяет наличие заказа в вашей системе.
* На ваш avisoURL мы отправляем информацию о том, что ваш покупатель оплатил заказ ([action=paymentAviso](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-aviso-docpage/)).

##### Описание процесса платежа
1. Плательщик нажимает "оплатить" на вашем сайте.
2. Затем из вашей формы POST-запросом передаются [параметры](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/) и их значения на наш обработчик https://demomoney.yandex.ru/eshop.xml, одновременно происходит редирект плательщика на сайт Яндекс.Деньги.
3. Далее наша система проверяет полученные на eshop.xml параметры.  
**3.1.** Если полученные параметры и их значения верные, плательщик видит [нашу страницу оплаты](https://demomoney.yandex.ru/eshop.xml?=shopid=72491&scid=541855&sum=100.00&customerNumber=значение%20из%20обязательного%20параметра%20customerNumber&orderNumber=значение%20из%20необязательного%20параметра%20orderNumber), выбирает способ оплаты, вводит необходимые данные (номер карты и т.д.), нажимает "оплатить".  
**3.2.** Если в переданных на eshop.xml параметрах наша система обнаружит ошибку (неверное название параметра или значение), пользователь увидит нашу страницы ошибки.  
4. После того, как на этапе п.3.1 пользователь нажал "оплатить", мы обращаемся POST-запросом к вашему checkURL, чтобы проверить, есть ли такой заказ у вас.  
**4.1.** Если ваш скрипт checkURL отвечает кодом "0" (да, такой заказ есть), мы инициируем процесс списания с баланса плательщика.  
**4.2.** Если скрипт checkURL отвечает любым другим кодом, ошибкой HTTP или просто ваш сайт не доступен по сети, мы показывает плательщику ошибку и платеж не проходит.  
5. Наша система инициирует списание средств с баланса плательщика (если на этапе п.4.1. ваш checkURL ответил "0").  
**5.1.** Если средств достаточно (карта рабочая и т.д.), мы холдируем (замораживаем) средства на балансе пользователя или если холд не возможен, списываем их.  
**5.2.** Если средств на балансе пользователя не достаточно (карта просрочена и т.д.), мы показываем эту информацию плательщику. Плательщик может вернуться на ваш сайт. Текущий платеж считается не успешным. Неуспешные платежи видны в Личном Кабинете Кассы как не оплаченные.
6. Далее наша система отправляет POST-запрос на ваш avisoURL о том, что заказ оплачен (мы называем этот этап "доставка авизо").  
**6.1.** Если ваш avisoURL отвечает кодом "0", деньги списываются с баланса пользователя.    
**6.2.** Если ваш avisoURL отвечает любым другим кодом, ошибкой HTTP или просто не доступен по сети, мы выполняем еще 6 попыток доставки авизо (с равномерным интервалом, примерно в течении трех часов). Далее, при повторах доставки авизо, если ваш avisoURL ответит "0", то см. п. 6.1.; но если мы получаем любой ответ кроме "0", то продолжаем попытки доставки на ваш avisoURL. Если все 6 попыток не удачные, то холд суммы оплаты заказа снимается и пользователь может использовать средства по своему назначению, либо, если не было холда и мы списали средства, то происходит автоматический возврат средств на баланс пользователя.
7. Сумма всех успешных платежей будет перечислена на ваш расчетный счет на следующий банковский день. На электронную почту вы получаете реестры со списком оплаченных заказов за предыдущие сутки (реестр оплаченых платежей); письмо приходит примерно с 6 до 10 утра, время московское.

##### 2.1. Проверка MD5 суммы при ответах на запросы checkOrder и paymentAviso

###### shopPassword
shopPassword - это пароль, который вы записали в нашей технической анкете при регистрации в Яндекс.Кассе. Данный пароль является частью защитного механизма при передаче данных (это не пароль от Личного Кабинета Яндекс.Кассы или пароль от вашего почтового ящика)

###### Проверка контрольной суммы MD5
В своем запросе на ваши checkURL и avisoURL мы передаем следующие параметры:
> action, orderSumAmount, orderSumCurrencyPaycash, orderSumBankPaycash, shopId, invoiceId, customerNumber, MD5

Это нужно, чтобы вы сверили MD5 сумму нашу и свою. Если сумма не совпадает, вы должны ответить кодом "1".

Формула рассчета MD5 суммы:
MD5(action;orderSumAmount;orderSumCurrencyPaycash;orderSumBankPaycash;shopId;invoiceId;customerNumber;shopPassword);
Полученный результат переводится в верхний регистр (например, вы получите его в таком виде md5=3F4C861280B12B74D6D6BD5CE3D14680).
Значение shopPassword, которое мы используем при подсчете MD5, хранится у нас в настройках вашего shopId.

##### Правильный ответ скрипта checkURL на POST-запрос action=checkOrder
    <?xml version="1.0" encoding="UTF-8"?>
    <checkOrderResponse performedDatetime="2011-05-04T20:38:01.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>

##### Правильный ответ скрипта avisoURL на POST-запрос action=paymentAviso
    <?xml version="1.0" encoding="UTF-8"?>
    <paymentAvisoResponse performedDatetime="2011-05-04T20:38:11.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>

Кроме кода "0", е
_тестирование_  
Вы должны выполнить успешный платеж любыми методом, это и будет результатом, после которого вам включат боевой режим. В демо доступны: оплата демо.кошельком, оплата демо.картой и демо.наличными. Если работает хотя бы один метод, значит остальные методы тоже будут работать.
