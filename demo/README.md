Интеграция оплаты, режим демо, Яндекс.Касса
========================================
**#инструкция для самописных сайтов**

`Представленной информации достаточно для того, чтобы вы смогли реализовать оплату на вашем сайте с помощью платежной системы Яндекс.Касса [всеми доступными платежными методами](https://kassa.yandex.ru/payments).`

### Требования к интеграции
* Вы должны [зарегистрироваться в Яндекс.Кассе](https://money.yandex.ru/joinups/) (доступно только для юридических лиц и ИП);
* Заполнить нашу [техническую анкету](https://tech.yandex.ru/money/doc/payment-solution/shop-config/parameters-docpage/);
* Получить от нас идентификаторы **shopId** и **scid**;
* Ваш сайт должен поддерживать работу по HTTPS протоколу;
* Ваши скрипты checkURL и avisoURL должны [корректно](#Шаг-22-Примеры-ответов-колбеков-checkurl-и-avisourl) отвечать на наши запросы.

#### Вашему программисту понадобится
* [Пример html-кода простой платежной формы](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/пример%20платежной%20формы.html)
* [Объяснение процесса платежа](#Описание-процесса-платежа)
* [Рекомендации по скриптам взаимодействия (checkURL и avisoURL)](#Шаг-2-Скрипты-checkurl-и-avisourl-колбеки)

#### Демо и презентации
* [Заплати через Яндекс](#Заплатить-через-Яндекс) _(страница-презентация о сценарии оплаты с максимальным удобством и конверсией)_
* [Все методы оплаты](https://kassa.yandex.ru/payments) _(видео процесса оплаты и pdf-презентация по каждому методу)_
* [Демонстрационный стенд](#Демонстрационный-стенд) _(вы можете попробовать сами процесс оплаты в действии)_

---

### Шаги интеграции

Для начала интеграции необходимы **shopId** и **scid**. Вы получите их в письме после того, как менеджер Яндекс.Кассы выполнит процесс вашей регистрации:
> **shopId** (идентификатор магазина) = **100500**  
> **scid** (номер витрины) = **555777**  
> _это пример идентификаторов из письма_

### Общий план

1. Создайте платежную форму, прописав в ней ваши **shopId** и **scid**;
2. Создайте скрипты для обработки наших запросов (скрипт checkURL и скрипт avisoURL);  
**2.1** Проверьте корректность сверки MD5-суммы и коды ответов ваших checkURL и avisoURL;  
**2.2** Посмотрите примеры ответов колбеков checkURL и avisoURL;  
**2.3** Узнайте, как определить, каким методом была произведена оплата (яндекс.кошелек, карты и т.д.);  
3. Выполните тестирование оплаты;  
**3.1** Если платеж не проходит, обратитесь к разделу "[Решение ошибок при тестировании](#31-Решение-ошибок-при-тестировании)"
4. После успешной оплаты в демо-режиме, напишите нам и мы переведем вас в боевой режим.
5. Если при тестировании возникнут ошибки и информации на данной странице будет не достаточно, напишите нам.

### Описание процесса платежа
| Подробное описание                                    | Краткое описание        |
| ----------------------------------------------------- | ----------------------- |
| 1. Плательщик нажимает "оплатить" на вашем сайте.     | Сайт клиента, оплатить.  |
| 2. Затем из вашей формы POST-запросом передаются [параметры](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/) и их значения на наш обработчик https://demomoney.yandex.ru/eshop.xml, одновременно происходит редирект плательщика на сайт Яндекс.Деньги. | POST; редирект на https://money.yandex.ru/ |
| 3. Далее наша система проверяет полученные на eshop.xml параметры. | Проверка данных. |
| **3.1.** Если полученные параметры и их значения верные, плательщик видит [нашу страницу оплаты](https://demomoney.yandex.ru/eshop.xml?shopid=72491&scid=541855&sum=100.00&customerNumber=%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%B7%20%D0%BE%D0%B1%D1%8F%D0%B7%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B0%20customerNumber ), выбирает способ оплаты, вводит необходимые данные (номер карты и т.д.), нажимает "оплатить". | Если ОК, то страница оплаты. | 
| **3.2.** Если в переданных на eshop.xml параметрах наша система обнаружит ошибку (неверное название параметра или значение), пользователь увидит нашу страницы ошибки. | Если ошибка, то страница ошибки. |
| 4. После того, как на этапе п.3.1 пользователь нажал "оплатить", мы обращаемся POST-запросом к вашему checkURL, чтобы проверить, есть ли такой заказ у вас. | POST на checkURL. |
| **4.1.** Если ваш скрипт checkURL отвечает кодом "0" ("да, такой заказ есть"), мы инициируем процесс списания с баланса плательщика (п.5). | `code="0"`, начинаем списание средств. | 
| **4.2.** Если скрипт checkURL отвечает любым другим кодом, ошибкой HTTP или просто ваш сайт не доступен по сети, мы показывает плательщику ошибку и платеж не проходит. | `code="1"`, показываем ошибку платежа. |
| 5. Наша система инициирует списание средств с баланса плательщика (если на этапе п.4.1. ваш checkURL ответил "0"). | |
| **5.1.** Если средств достаточно (карта рабочая и т.д.), мы холдируем (замораживаем) средства на балансе пользователя или если холд не возможен, списываем их. | Средств достаточно? Холдируем или списываем. |
| **5.2.** Если средств на балансе пользователя не достаточно (карта просрочена и т.д.), мы показываем эту информацию плательщику. Плательщик может вернуться на ваш сайт. Текущий платеж считается не успешным. Неуспешные платежи видны в Личном Кабинете Кассы как не оплаченные. | Средств не достаточно, иная ошибка? Показываем ошибку пользователю. |
| 6. Далее наша система отправляет POST-запрос на ваш avisoURL о том, что заказ оплачен (мы называем этот этап "доставка авизо"). | POST на avisoURL. |
| **6.1.** Если ваш avisoURL отвечает кодом "0", деньги списываются с баланса пользователя. | `code="0"`, зачисляем средства в магазин |
| **6.2.** Если ваш avisoURL отвечает любым другим кодом, ошибкой HTTP или просто не доступен по сети, мы выполняем еще 6 попыток доставки авизо (с равномерным интервалом, примерно в течении трех часов). Далее, при повторах доставки авизо, если ваш avisoURL ответит "0", то см. п. 6.1.; но если мы получаем любой ответ кроме "0", то продолжаем попытки доставки на ваш avisoURL. Если все 6 попыток не удачные, то холд суммы оплаты заказа снимается и пользователь может использовать средства по своему назначению, либо, если не было холда и мы списали средства, то происходит автоматический возврат средств на баланс пользователя. | `code="1"`, стучимся еще 6 раз; средства не зачисляются, если `code="1"`. |
| 7. Сумма всех успешных платежей будет перечислена на ваш расчетный счет на следующий банковский день. На электронную почту вы получаете реестры со списком оплаченных заказов за предыдущие сутки (реестр оплаченых платежей); письмо приходит примерно с 6 до 10 утра, время московское. | Деньги на Р/С. Реестр на email. | 

### Заплатить через Яндекс

"Заплатить через Яндекс" - это рекомендуемый нами сценарий оплаты:
* [презентация](https://kassa.yandex.ru/pay_by_yandex);
* файл дизайна кнопки: [pay_by_yandex_btn.zip](https://kassa.yandex.ru/files/pay_by_yandex_btn.zip);
* [посмотреть "Оплатить через Яндекс" в дествиии](#Демонстрационный-стенд) и сравнить с другими вариантами оплаты.

Описание: плательщик нажимает на вашем сайте кнопку "оплатить", автоматически попадает на страницу Яндекс.Деньги, где выбирает нужный способ оплаты. Если ваш сайт передает только пустой `paymentType=""`, то покупатель видит страницу с возможностью выбора платежного метода (кошелек, карты, сбербанк и т.д.). Если передается пустой `paymentType=""` и номер телефона пользователя `cps_phone=71231231212`, тогда наша система показывает те методы платежа, которые для данного пользователя максимально удобны, он ими пользовался ранее.

Плюсы: использование метода "Заплатить через Яндекс" значительно повышает конверсию и удобство оплаты, упрощает техническую интеграцию (при появлении нового метода оплаты он автоматически станет виден вашему покупателю и вам не потребуется добавлять этот метод в код своих скриптов).

### Шаг 1. Платежная форма
Файл "[пример платежной формы.html](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/пример%20платежной%20формы.html)" содержит необходимый код, чтобы выполнить тестовый платеж. Скопируйте код к себе, отредактируйте, прописав свои значения **shopId** и **scid**. В файле примера это будут следующие строки:

```html
    <input name="shopId" value="впишите-сюда-значение-своего-shopId" type="hidden">
    <input name="scid" value="впишите-сюда-значение-своего-scid-для-демо-режима" type="hidden">
```
Вставьте код в html-документ или добавьте на страницу своего сайта. Минимальная платежная форма готова.

Обратите внимание:
* обязательными параметрами платежа являются **shopId**, **scid**, **customerNumber** и **sum**, без них платежи работать не будут (customerNumber - идентификатор плательщика, например, "Покупатель N1"; sum - сумма платежа в рублях);
* если вы хотите передавать больше данных из формы, прочитайте как это сделать в [документации](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/);
* для демо платежей и платежей в реале, значение shopId одинаковое;
* значение scid для демо будет одно, а для реала другое; если вы пропишите боевой scid для платежей в демо, то платежи в демо работать не будут.

### Шаг 2. Скрипты checkURL и avisoURL (колбеки)

При регистрации в Яндекс.Кассе вы заполняли техническую анкету, где должны были указать ссылки на ваши скрипты, которые будут обрабатывать наши запросы. У нас они называются checkURL и avisoURL. URL этих скриптов прописаны в настройках вашего shopId.

* На ваш checkURL мы отправляем POST-запрос ([action=checkOrder](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-check-docpage/)), который проверяет наличие заказа в вашей системе.
* На ваш avisoURL мы отправляем POST-запрос о том, что ваш покупатель оплатил заказ ([action=paymentAviso](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-aviso-docpage/)).

### Шаг 2.1. Проверка MD5 суммы при ответах на запросы checkOrder и paymentAviso ([документация](https://tech.yandex.ru/money/doc/payment-solution/payment-notifications/payment-notifications-http-docpage/))

В своем запросе на ваши checkURL и avisoURL мы передаем следующие параметры:
> action, orderSumAmount, orderSumCurrencyPaycash, orderSumBankPaycash, shopId, **invoiceId**, customerNumber, **MD5**

Это нужно, чтобы вы сверили MD5 сумму нашу и свою. Если сумма не совпадает, вы должны ответить кодом "1". Данный механизм предназначен для защиты значения суммы оплаты от подделки (а также значение customerNumber), после того, как эти параметры передаются из вашей формы в нашу платежную систему.

###### Формула рассчета MD5 суммы
> MD5(action;orderSumAmount;orderSumCurrencyPaycash;orderSumBankPaycash;shopId;invoiceId;customerNumber;shopPassword);

Полученный результат переводится в верхний регистр (например, вы получите его от нас в таком виде md5=3F4C861280B12B74D6D6BD5CE3D14680). Подробности:

* shopPassword - это пароль, который вы записали в нашей технической анкете при регистрации в Яндекс.Кассе; данный пароль является частью защитного механизма при передаче данных (это не пароль от Личного Кабинета Яндекс.Кассы или пароль от вашего почтового ящика);
* значение shopPassword, которое мы используем при подсчете MD5, хранится у нас в настройках вашего shopId;
* invoiceId - номер платежа в системе Яндекс.Касса (это наш основной идентификатор всех платежей; в Личном Кабинете при просмотре списка платежей вы будете видеть для каждого платежа свой уникальный номер).

### Шаг 2.2. Примеры ответов колбеков checkURL и avisoURL

##### В HTTP заголовке (header) ответа должно быть:
 * `HTTP/1.0 200`
 * `Content-Type: application/xml`

##### В теле (body) ответа вашего скрипта checkURL на POST-запрос action=checkOrder должно быть:
```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <checkOrderResponse performedDatetime="2011-05-04T20:38:01.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>
```
##### В теле (body) ответ вашего скрипта avisoURL на POST-запрос action=paymentAviso должно быть:
```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <paymentAvisoResponse performedDatetime="2011-05-04T20:38:11.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>
```
##### Все коды ответов
* `code="0"` - такой заказ есть в магазине, можно продолжать оплату (action=checkOrder) или магазин принимает оплату по данному заказу (action=paymentAviso)
* `code="1"` - полученная MD5-сумма не совпадает с MD-суммой на стороне магазина (ответ при action=checkOrder и action=paymentAviso)
* `code="100"` - такого заказа нет в магазине (например, срок действия заказа истёк; только для action=checkOrder)
* `code="200"` - не удается выполнить разбор полученных параметров (ответ при action=checkOrder и action=paymentAviso)

##### Пример CURL, эмулирующий наш запрос на ваш checkURL
```bash
curl -kvd 'action=checkOrder&shopId=100500&scid=555777&customerNumber=32&cdd_pan_mask=444444|4448 \
&orderNumber=38&paymentType=AC&invoiceId=2000000833650&shopSumAmount=100.00&md5=2A409E2B81D7A77A2B745A2F62916C42 \
&orderSumAmount=3200.00&cdd_exp_date=1217&paymentPayerCode=4100322062290&cdd_rrn=&external_id=deposit \
&requestDatetime=2016-07-11T15:29:35.438+03:00&depositNumber=tNGTnJmP7sPdWnPiSeOXLUFLB5MZ.001f.201607 \
&cps_user_country_code=PL&orderCreatedDatetime=2016-07-11T15:29:35.360+03:00&sk=yed009c9df4e4f0a47d15e20d4af3231e \
&shopSumBankPaycash=1003&shopSumCurrencyPaycash=10643&rebillingOn=false&orderSumBankPaycash=1003&cps_region_id=213 \
&orderSumCurrencyPaycash=10643&merchant_order_id=38_110716152918_00000_64759 \
&unilabel=1f15a4dd-0009-5000-8000-0000116d476c&yandexPaymentId=2570052456918' https://yousite/checkURL-script.php
```

### Шаг 2.3. Определение типа платежа, которым была произведена оплата
Если вам нужно понимать, каким методом оплачивает плательщик, обратите внимание, что в запросах checkOrder и paymentAviso мы передаем вам параметр paymentType. Например, paymentType=PC (это значит, что оплата производится через яндекс.кошелек; [список способов оплаты](https://tech.yandex.ru/money/doc/payment-solution/reference/payment-type-codes-docpage/)).

### Шаг 3. Тестирование оплаты

Вы должны выполнить успешный платеж в демо-среде любыми методом (кошельком, картой или наличными через терминал; см. инструкцию ниже). Платеж должнен быть выполнен с использованием ваших shopid и scid. Это и будет результатом, после которого вам включат боевой режим. Если работает хотя бы один метод, значит остальные методы тоже будут работать. Для примера можно посмотреть на [демонстрационный стенд](#Демонстрационный-стенд). В демо-среде рекомендуем тестировать не большими суммами, например, 100 руб. `sum="100.00"`.

##### Лимиты суммы оплаты
У каждого платежного метода есть свои лимиты (минимальный и максимальный размер суммы). Например, оплата Яндекс.Кошельком с идентификацией уровня "Анонимный" может быть от 1 руб. до 15 тыс.рублей. Лимиты одинаковы как в демо среде, так и в боевой. См. [таблица лимитов платежных методов](https://money.yandex.ru/doc.xml?id=527483&ncrnd=6790). Если сумма не будет проходить по лимитам, мы сообщим об этом плательщику на странице оплаты. 

##### Тестовый демо-кошелек
1. **Создайте свой тестовый кошелек** за 1 минуту: пройдите по ссылке https://demomoney.yandex.ru/reg/ (вы сможете сделать себе тестовый кошелек, если у вас уже есть учетная запись в яндекс; если ее нет, ее надо создать, чтобы затем получить персональный тестовый кошелек; обратите внимание, что в демо режиме кошелек всегда будет с [минимальной идентификации](https://money.yandex.ru/security/identification/) уровня "Анонимный", а значит и лимит платежей от 1 до 15 тыс. руб.).
2. **Пополнить тестовый кошелек**: перейдите по ссылке https://demomoney.yandex.ru/shop.xml?scid=50215, введите номер своего кошелька и сумму (номер кошелька можно узнать, нажав на кнопке кошелька в верхнем правом углу экрана).

##### Тестовая демо банковская карта
* карта 4444 4444 4444 4448;
* cvv 000;
* действует до: любая дата в будущем;
* тестовую карту не нужно пополнять демо-деньгами, они там есть всегда.

##### Тестовая оплата демо-наличными через терминал
Выберите оплату наличными через терминал, напишите номер телефона в формате `+71231231212` (также можно указать адрес электронной почты) и нажмите "Продолжить". Далее на экран вы получите код (кроме того, код придет на указанный вами телефон в виде смс; если вы указали e-mail, то код придет на почту). Далее, вместо того, чтобы пойти и ввести полученный код в терминал, используйте наш [тестовый терминал](https://demomoney.yandex.ru/shop.xml?scid=50215). Введите в нем полученный код и сумму платежа (она должна совпадать с той суммой, на которую нужно оплатить заказ в вашем тестовом магазине). Все, платеж выполнен.

### Демонстрационный стенд

Здесь, на примере нашего специального магазина (shopid=72491, scid=541855), можно провести оплату демо деньгами, посмотреть на процесс и результат. Обратите внимание, что в демо среде идет постоянный процесс разработки, поэтому, в исключительных случаях, в конкретный момент времени один из методов может быть не доступен.

| Метод оплаты и ссылка на демо                         | Код вызова         |
| ----------------------------------------------------- | ------------------ |
| **["Заплатить через Яндекс"](https://goo.gl/QBgppN)** | `paymentType=""`   |
| [Оплата яндекс.кошельком](https://goo.gl/Gc20LK)      | `paymentType="PC"` |
| [Оплата банковской картой](https://goo.gl/ZblF7F)     | `paymentType="AC"` |
| [Оплата наличными в терминал](https://goo.gl/ZYiuaN)  | `paymentType="GP"` |

##### Как сделаны ссылки в этой таблице?
Кроме того, что вы можете передавать параметры из своей формы POST-запросом, есть альтернативный метод, когда формируется платежная ссылка, нажав на которую происходит открытие платежной страницы с оплатой конкретного заказа. [Подробнее](https://tech.yandex.ru/money/doc/payment-solution/payment-process/payments-qr-docpage/) об этом методе. Если взять за пример первую ссылку в таблице, то она выглядит так:
```
https://demomoney.yandex.ru/eshop.xml?shopid=72491&scid=541855&sum=100.00&customerNumber=test
```
### 3.1. Решение ошибок при тестировании

Если при тестировании вы получили ошибку, используйте следующие пункты:

1. Проверьте, чтобы ваш домен был доступен по HTTPS. Обратитесь к своему сайту по https протоколу, ссылка будет выглядеть так https://имясайта.ру, если сайт не открывается, решите этот вопрос с техподдержкой вашего хостинга или системным администратором вашего сервера. Если нужен бесплатный SSL-сертификат, обратитесь к своему персональному менеджеру по адресу merchants@yamoney.ru, указав в теме письма: "shopid=ваш-номер нужен бесплатный SSL".
2. Проверьте, чтобы при обращении к сайту не происходило никаких редиректов с https на http, с www на основное имя, или наоборот. Самое главное, чтобы при обращении к https://имя-сайта/скрипт-чек-или-авизо не происходило никаких редиректов.
3. Проверьте, чтобы при подсчете MD5 суммы, был указан корректный shopPassword. Подробнее https://clck.ru/9yZFg
4. При платеже в демо среде в вашей форме должен быть указан именно демо scid, а не боевой (вы получаете его в письме, где явным образом указано, что это демо scid).

Если рекомендации 1-4 вам не помогли, то:
- пришлите ссылку на страницу вашего сайта, на которой мы бы могли выполнить тестовую оплату самостоятельно;
- пришлите ссылку на страницу ошибки, которую вы получили при выполнении платежи;
- по возможности пришлите нам данные, которые передаются из вашей платежной формы, см. инструкцию https://clck.ru/9yYy5
