Тестирование оплаты в демо, Яндекс.Касса
========================================
**Инструкция для самописных сайтов**  
На этой странице вы найдете пример кода платежной формы, пошаговое описание тестирования, решение ошибок при тестировании, презентацию процесса оплаты методом "оплатить через яндекс", ссылки на необходимые документы и файлы дизайна, раздел FAQ и раздел Рекомендации.

---

### Тестирование

Для тестирования необходимы **shopId** и **scid**. Вы получите их в письме, после того, как менеджер яндекс.кассы выполнит процесс вашей регистрации:
> **shopId** (идентификатор магазина) = **100500**  
> **scid** (номер витрины) = **555777**  
> _это пример идентификторов из письма_

1. Создать форму оплаты, прописав в ней **shopId** и **scid**.
2. Создать скрипты для обработки наших запросов (checkURL, avisoURL).
3. Выполнить тестирование.
4. После успешной оплаты в демо-режиме, напишите в ответ на наше письмо и мы переведем вас в боевой режим. Если при оплате в демо-режиме возникнут ошибки и информации на данной странице будет не достаточно, напишите в ответ на наше письмо и наши техники помогут вам (подробнее о том, какая информация нам нужна для диагностики, см. в инструкции ниже).

#### Шаг 1. Код платежной формы
Файл "пример платежной формы.html" содержит необходимый код, чтобы выполнить тестовый платеж. Скопируйте код к себе и отредактируйте, прописав в коде свои значения **shopId** и **scid**. В файле примера это будут следующие строки:

    <input type="hidden" name="shopId" value="впишите-сюда-значение-своего-shopId">
    <input type="hidden" name="scid" value="впишите-сюда-значение-своего-scid">

Полученный код вставьте в html-документ или добавьте на страницу вашего сайта. Минимальная платежная форма готова.

Обратите внимание:
* обязательными параметрами платежа являются **shopId**, **scid**, **customerNumber** и **sum**, без них платежи работать не будут;
* если выхотите передавать больше данных из формы, прочитайте как это сделать в [документации](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/);
* для демо платежей и платежей в реале, значение shopId одинаковое;
* значение scid для демо будет одно, а для реала другое (scid для платежей в реале вы получите от нас после того, как напишите нам о том, что демо-платежи проходят успешно, после мы включим для вашего shopId возможность платить в реальном режиме и пришлем боевой scid).

#### Шаг 2. Колбеки checkURL и avisoURL

При регистрации в Яндекс.Кассе вы заполняли техническую анкету, где должны были указать ссылки на ваши скрипты, которые будут обрабатывать наши запросы. У нас они называются checkURL и avisoURL. URL этих скриптов прописаны в настройках вашего shopId.

На ваш checkURL мы отправляем запрос, который проверяет наличие заказа в вашей системе. На ваш avisoURL мы отправляем информацию о том, что ваш покупатель оплатил заказ.

##### Описание процесса платежа
1. Плательщик нажимает "оплатить" на вашем сайте.
2. Из вашей формы POST-запросом передаются [параметры](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/) на наш https://demomoney.yandex.ru/eshop.xml
3. Наша система проверяет полученные на eshop.xml параметры и если они верные, плательщик видит нашу страницы оплаты, выбирает способ оплаты, вводит номер карты и т.д., нажимает "оплатить".  
**3.1.** Если в переданных на eshop.xml параметрах наша система обнаружит ошибку (неверное название параметра или значение), пользователь увидит нашу страницы ошибки.  
4. После того, как на этапе п.3 пользователь нажал "оплатить" на нашей странице, мы обращаемся POST-запросом к вашему checkURL, чтобы проверить, есть ли такой заказ у вас.  
**4.1.** Если ваш скрипт checkURL отвечает кодом "0" (да, такой заказ есть), мы инициируем процесс списания с баланса плательщика.  
**4.2.** Если скрипт checkURL отвечает любым другим кодом, ошибкой HTTP или просто ваш сайт не доступен по сети, мы показывает плательщику ошибку и платеж не проходит.  
5. Наша система инициирует списание средств с баланса плательщика (если на этапе п.4 ваш checkURL ответил "0").  
**5.1.** Если средств на балансе пользователя не достаточно (карта просрочена и т.д.), мы показываем эту информацию плательщику. Плательщик может вернуться на ваш сайт. Текущий платеж считается не успешным. Неуспешные платежи видны в Личном Кабинете Кассы как не оплаченные.  
**5.2.** Если средств достаточно (карта рабочая и т.д.), мы холдируем (замораживаем) средства на балансе пользователя или если холд не возможен, списываем их.  
6. Далее наша система отправляет POST-запрос на ваш avisoURL о том, что такой-то заказ оплачен.  
**6.1.** Если ваш avisoURL отвечает кодом "0", деньги списываются с баланса пользователя.    
**6.2.** Если ваш avisoURL отвечает любым другим кодом, ошибкой HTTP или просто не доступен по сети, мы выполняем еще 6 попыток доставки информации об оплате (с равномерным интервалом, примерно в течении трех часов). Если ваш avisoURL отвечает "0", то см. п. 6.1., если мы получаем любой ответ кроме "0", то продолжаем попытки доставки на ваш avisoURL. Если все 6 попыток не удачные, то холд суммы оплаты заказа снимается и пользователь может использовать средства по своему назначению, либо, если не было холда и мы списали средства, то происходит автоматический возврат средств на баланс пользователя.  
7. Сумма всех успешных платежей будет перечислена на ваш расчетный счет на следующий банковский день. На электронную почту вы получаете реестры со списком оплаченных заказов за предыдущие сутки (реестр оплаченых платежей); письмо приходит примерно с 6 до 10 утра, время московское.

Это может быть один скрипт, например, https://yousite/script.php, которые будет обрабатывать

_shopid_  
это цифровой идентификатор вашего магазина в системе Яндекс.Касса, для демо и боевого режима, идентификатор один и тот же  
_scid_  
это цифровой идентификатор вашей платежной страницы в системе Яндекс.Касса, в демо вы получаете один идентификтор, а когда магазин пройдет тестирование, вы получите новое значение scid; демо scid работает только в демо, боевой scid работает только в боевом режиме

_тестирование_  
Вы должны выполнить успешный платеж любыми методом, это и будет результатом, после которого вам включат боевой режим. В демо доступны: оплата демо.кошельком, оплата демо.картой и демо.наличными. Если работает хотя бы один метод, значит остальные методы тоже будут работать.
