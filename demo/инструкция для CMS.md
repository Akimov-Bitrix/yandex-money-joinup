> [шаги интеграции](#Шаги-интеграции), [общий план](#Общий-план), [установка](#Шаг-1-Установка-включение-платежного-модуля), [настройка](#Шаг-2-Настройка-платежного-модуля), [curl](#Пример-curl-эмулирующий-наш-запрос-на-ваш-checkurl), [тестирование](#Шаг-3-Тестирование-оплаты), [ошибки и решение](#31-Решение-ошибок-при-тестировании), [демо-стенд](#Демонстрационный-стенд)

Интеграция оплаты в Яндекс.Кассе с помощью готового платежного модуля
=====================================================================

**#инструкция для сайтов, созданных на основе CMS или SaaS-решений, тестовый режим**

### Требования к интеграции
* [Зарегистрируйтесь в Яндекс.Кассе](https://money.yandex.ru/joinups/) (доступно только для юридических лиц и ИП);
* Заполните нашу [техническую анкету](https://tech.yandex.ru/money/doc/payment-solution/shop-config/intro-docpage/);
* Получите от нас идентификаторы **shopId** и **scid**;
* Ваш сайт должен поддерживать работу по HTTPS протоколу;
* Платежный модуль должен быть установлен или включен (если модуль встроенный) и настроен на тестовые платежи.

---

### Шаги интеграции

Для начала интеграции необходимы **shopId** и **scid**. Вы получите их в письме после того, как менеджер Яндекс.Кассы выполнит процесс вашей регистрации:
> **shopId** (идентификатор магазина) = **100500**  
> **scid** (номер витрины) = **555777**  
> _это пример идентификаторов из письма_

### Общий план

1. Установите или включите платежный модуль в CMS;
2. Пропишите в настройках **shopId**, **scid**, **shopPassword** и включите "тестовый режим";
3. Выполните тестирование оплаты;
4. После успешной оплаты в "тестовом режиме", напишите нам и мы переведем вас в боевой режим;
5. Если при тестировании возникнут ошибки и информации на данной странице будет не достаточно, напишите нам.

### Шаг 1. Установка (включение) платежного модуля

1. Выберите нужную CMS из списка ([список модулей](https://kassa.yandex.ru/integration#cms))
2. Установите или включите модуль.

### Шаг 2. Настройка платежного модуля

1. Выполните настройку согласно инструкции.
2. Пропишите в настройках **shopId**, **scid**, **shopPassword** и включите "текстовый режим".
3. В настройках оплаты выберите "Выбор способа оплаты на стороне Яндекс.Кассы" (т.н. метод "[Заплати через Яндекс](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/заплатить%20через%20яндекс.md)").

Дополнительно:

* shopPassword - это пароль, который вы записали в нашей технической анкете при регистрации в Яндекс.Кассе; данный пароль является частью защитного механизма при передаче данных (это не пароль от Личного Кабинета Яндекс.Кассы или пароль от вашего почтового ящика);
* значение shopPassword, которое мы используем при подсчете MD5, хранится у нас в настройках вашего shopId;
* invoiceId - номер платежа в системе Яндекс.Касса (это наш основной идентификатор всех платежей; в Личном Кабинете при просмотре списка платежей вы будете видеть для каждого платежа свой уникальный номер; обратите внимание, что в ЛК не отображаются демо платежи).

##### Пример CURL, эмулирующий наш запрос на ваш checkURL

Если вы программист или техник, которому необходимо протестировать ответ колбеков, это можно сделать так. Ссылку на конкретный колбек можно узнать в инструкции по платежному модулю или посмотреть в настройках модуля.

```bash
curl -kvd 'action=checkOrder&shopId=100500&scid=555777&customerNumber=32&cdd_pan_mask=444444|4448 \
&orderNumber=38&paymentType=AC&invoiceId=2000000833650&shopSumAmount=100.00&md5=2A409E2B81D7A77A2B745A2F62916C42 \
&orderSumAmount=3200.00&cdd_exp_date=1217&paymentPayerCode=4100322062290&cdd_rrn=&external_id=deposit \
&requestDatetime=2016-07-11T15:29:35.438+03:00&depositNumber=tNGTnJmP7sPdWnPiSeOXLUFLB5MZ.001f.201607 \
&cps_user_country_code=PL&orderCreatedDatetime=2016-07-11T15:29:35.360+03:00&sk=yed009c9df4e4f0a47d15e20d4af3231e \
&shopSumBankPaycash=1003&shopSumCurrencyPaycash=10643&rebillingOn=false&orderSumBankPaycash=1003&cps_region_id=213 \
&orderSumCurrencyPaycash=10643&merchant_order_id=38_110716152918_00000_64759 \
&unilabel=1f15a4dd-0009-5000-8000-0000116d476c&yandexPaymentId=2570052456918' https://yousite/checkURL-script.php
```

### Шаг 3. Тестирование оплаты

Вы должны выполнить успешный платеж в демо-среде одним из доступных методов (см. инструкцию ниже):

```diff
+ в демо среде доступна оплата только демо-кошельком, демо-картой и демо-наличными через демо-терминал
- в демо среде НЕ доступны все остальные методы (Сбербанк-онлайн, Мастерпас и т.д.)
```

Платеж должнен быть выполнен с использованием ваших shopid и scid. Это и будет результатом, после которого вам включат боевой режим. Если работает хотя бы один метод, значит остальные методы тоже будут работать. Для примера можно посмотреть на [демонстрационный стенд](#Демонстрационный-стенд).

##### Лимиты суммы оплаты
У каждого платежного метода есть свои лимиты (минимальный и максимальный размер суммы). Например, оплата Яндекс.Кошельком с идентификацией уровня "Анонимный" может быть от 1 руб. до 15 тыс.рублей. Лимиты одинаковы как в демо среде, так и в боевой. См. [таблица лимитов платежных методов](https://money.yandex.ru/doc.xml?id=527483&ncrnd=6790). Если сумма не будет проходить по лимитам, мы сообщим об этом плательщику на странице оплаты. В демо-среде рекомендуем тестировать не большими суммами, например, 100 руб. `sum="100.00"`.

##### Тестовый демо-кошелек

```diff
+ Для оплаты кошельком, вы должны обязательно его зарегистрировать и залогиниться в него
- если инициировать оплату демо-кошельком не создав его и не залогинившись в него, то на странице оплаты
- не будет доступна оплата кошельком
```

1. **Создайте свой тестовый кошелек** за 1 минуту:
  * зарегистрируйте себе яндекс-кошелек в https://money.yandex.ru (если он есть, авторизуйтесь в него)
  * пройдите по ссылке https://demomoney.yandex.ru/reg/ (вы сможете сделать себе тестовый кошелек, если у вас уже есть учетная запись в яндекс; если ее нет, ее надо создать, чтобы затем получить персональный тестовый кошелек; обратите внимание, что в демо режиме кошелек всегда будет с [минимальной идентификации](https://money.yandex.ru/security/identification/) уровня "Анонимный").
2. **Пополнить тестовый кошелек**: перейдите по ссылке https://demomoney.yandex.ru/shop.xml?scid=50215, введите номер своего кошелька и сумму (номер кошелька можно узнать, нажав на кнопке кошелька в верхнем правом углу экрана).

##### Тестовая демо банковская карта
* карта 4444 4444 4444 4448;
* действует до: любая дата в будущем;
* cvv 000;
* тестовую карту не нужно пополнять демо-деньгами, они там есть всегда.

##### Тестовая оплата демо-наличными через терминал
Выберите оплату наличными через терминал, напишите номер телефона в формате `+71231231212` (также можно указать адрес электронной почты) и нажмите "Продолжить". Далее на экран вы получите код (кроме того, код придет на указанный вами телефон в виде смс; если вы указали e-mail, то код придет на почту). Далее, вместо того, чтобы пойти и ввести полученный код в терминал, используйте наш [тестовый терминал](https://demomoney.yandex.ru/shop.xml?scid=50215). Введите в нем полученный код и сумму платежа (она должна совпадать с той суммой, на которую нужно оплатить заказ в вашем тестовом магазине). Все, платеж выполнен.

### 3.1. Решение ошибок при тестировании

Если при тестировании вы получили ошибку, используйте следующие пункты:

1. Проверьте, чтобы ваш домен был доступен по HTTPS. Обратитесь к своему сайту по https протоколу, ссылка будет выглядеть так https://имясайта.ру, если сайт не открывается, решите этот вопрос с техподдержкой вашего хостинга или системным администратором вашего сервера. Если нужен бесплатный SSL-сертификат, обратитесь к своему персональному менеджеру по адресу merchants@yamoney.ru, указав в теме письма: "shopid=ваш-номер нужен бесплатный SSL".
2. Проверьте, чтобы при обращении к сайту не происходило никаких редиректов с https на http, с www на основное имя, или наоборот. Самое главное, чтобы при обращении к https://имя-сайта/скрипт-чек-или-авизо не происходило никаких редиректов.
3. Проверьте, чтобы в настройках платежного модуля был указан верный shopPassword.
4. При платеже в демо среде в вашей форме должен быть указан именно демо scid, а не боевой (вы получаете его в письме, где явным образом указано, что это демо scid).

Если рекомендации 1-4 вам не помогли, то:
- пришлите ссылку на страницу вашего сайта, на которой мы бы могли выполнить тестовую оплату самостоятельно;
- пришлите ссылку на страницу ошибки, которую вы получили при выполнении платежа;
- по возможности пришлите нам данные, которые передаются из вашей платежной формы, см. инструкцию https://clck.ru/9yYy5

### Демонстрационный стенд

Здесь, на примере нашего специального магазина (shopid=72491, scid=541855), можно провести оплату демо деньгами, посмотреть на процесс и результат. Обратите внимание, что в демо среде идет постоянный процесс разработки, поэтому, в исключительных случаях, в конкретный момент времени один из методов может быть не доступен.

| Метод оплаты и ссылка на демо                         | Код вызова         |
| ----------------------------------------------------- | ------------------ |
| **["Заплатить через Яндекс"](https://goo.gl/QBgppN)** | `paymentType=""`   |
| [Оплата яндекс.кошельком](https://goo.gl/Gc20LK)      | `paymentType="PC"` |
| [Оплата банковской картой](https://goo.gl/ZblF7F)     | `paymentType="AC"` |
| [Оплата наличными в терминал](https://goo.gl/ZYiuaN)  | `paymentType="GP"` |

##### Как сделаны ссылки в этой таблице?
Кроме того, что вы можете передавать параметры из своей формы POST-запросом, есть альтернативный метод, когда формируется платежная ссылка, нажав на которую происходит открытие платежной страницы с оплатой конкретного заказа. [Подробнее](https://tech.yandex.ru/money/doc/payment-solution/payment-process/payments-qr-docpage/) об этом методе. Если взять за пример первую ссылку в таблице, то она выглядит так:
```
https://demomoney.yandex.ru/eshop.xml?shopid=72491&scid=541855&sum=100.00&customerNumber=test
```
